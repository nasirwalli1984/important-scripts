
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET NOCOUNT ON
DECLARE @XML NVARCHAR(MAX)
SELECT @XML = CAST((SELECT  
   CASE  
       WHEN DTL.RESOURCE_TYPE IN ('DATABASE', 'FILE', 'METADATA') THEN DTL.RESOURCE_TYPE 
       WHEN DTL.RESOURCE_TYPE = 'OBJECT' THEN OBJECT_NAME(DTL.RESOURCE_ASSOCIATED_ENTITY_ID) 
       WHEN DTL.RESOURCE_TYPE IN ('KEY', 'PAGE', 'RID') THEN  
           ( 
           SELECT OBJECT_NAME([OBJECT_ID]) FROM SYS.PARTITIONS WHERE SYS.PARTITIONS.HOBT_ID = DTL.RESOURCE_ASSOCIATED_ENTITY_ID 
           ) 
       ELSE 'UNIDENTIFIED' 
   END AS 'TD','',SP_BLOCKING.[LOGINAME] AS 'TD','',
   SP_BLOCKING.HOSTNAME AS 'TD','',
   SP_BLOCKING.[PROGRAM_NAME] AS 'TD','',   
   (DOWT.WAIT_DURATION_MS/1000)/60 AS 'TD','',
   DOWT.WAIT_TYPE AS 'TD','', DOWT.SESSION_ID AS 'TD','', 
   SP_BLOCKED.[LOGINAME] AS 'TD','', 
   DEST_BLOCKED.[TEXT] AS 'TD','',
   DOWT.BLOCKING_SESSION_ID AS 'TD','',  
   DEST_BLOCKING.[TEXT] AS 'TD' 
     
FROM SYS.DM_TRAN_LOCKS DTL 
   INNER JOIN SYS.DM_OS_WAITING_TASKS DOWT with (nolock) ON DTL.LOCK_OWNER_ADDRESS = DOWT.RESOURCE_ADDRESS  
   INNER JOIN SYS.SYSPROCESSES SP_BLOCKED with (nolock) ON DOWT.[SESSION_ID] = SP_BLOCKED.[SPID]
   INNER JOIN SYS.SYSPROCESSES SP_BLOCKING with (nolock) ON DOWT.[BLOCKING_SESSION_ID] = SP_BLOCKING.[SPID]
   CROSS APPLY SYS.[DM_EXEC_SQL_TEXT](SP_BLOCKED.[SQL_HANDLE]) AS DEST_BLOCKED
   CROSS APPLY SYS.[DM_EXEC_SQL_TEXT](SP_BLOCKING.[SQL_HANDLE]) AS DEST_BLOCKING
WHERE DTL.[RESOURCE_DATABASE_ID] = DB_ID()
--AND (SELECT COUNT([BLOCKING_SESSION_ID]) FROM SYS.DM_OS_WAITING_TASKS with (nolock) where DTL.LOCK_OWNER_ADDRESS =RESOURCE_ADDRESS )>3 
--AND DOWT.WAIT_DURATION_MS >120000
AND DOWT.WAIT_DURATION_MS >15000
FOR XML PATH('TR'), ELEMENTS) AS NVARCHAR(MAX))
SELECT @XML
DECLARE @BODY NVARCHAR(MAX)
SET @BODY =
'<HTML>
 <HEAD>
 <STYLE>
 TABLE, TH, TD 
 {
 BORDER: 1PX SOLID BLACK;
 BORDER-COLLAPSE: COLLAPSE;
 TEXT-ALIGN: CENTER;
 }
 </STYLE>
 </HEAD>
 <BODY>
 <H2>
 BLOCKING QUERIES
 </H2>
 <TABLE STYLE="WIDTH:100%"> 
 <TR>
 <TH>REQUESTED_OBJECT_NAME</TH> <TH> BLOCKING_USER </TH> <TH> HOSTNAME</TH> 
 <TH> PROGRAM_NAME</TH><TH>WAIT_IN_MINTUES</TH><TH>WAIT_TYPE</TH><TH>BLOCKED_SESSION_ID</TH><TH>BLOCKED_USER</TH><TH>BLOCKED_COMMAND</TH><TH>BLOCKING_SESSION_ID</TH><TH>BLOCKING_COMMAND</TH>
 </TR>'
 SET @BODY = @BODY + @XML + '
 </TABLE>
 </BODY>
</HTML>'
IF(@XML IS NOT NULL)
BEGIN
EXEC MSDB.DBO.SP_SEND_DBMAIL
@PROFILE_NAME = 'MTBC-DATABASE',
@BODY = @BODY,
@BODY_FORMAT ='HTML',
@RECIPIENTS = 'MUBASHIR UL HAQ <mubashirulhaq@MTBC.COM>; YASIRALI4@MTBC.COM;kamransikander@mtbc.com;; ZAHID AYUB <zahidayub@MTBC.COM>',
@SUBJECT = 'BLOCKING QUERIES ALERT- TALKEHRDB-SRV';
END
SET NOCOUNT OFF

